<style>
    .centre {
        display: flex;
        justify-content: center;
        align-items: end;
        height: 100%;
    }
    #chatContainer {
        transition: all .25s linear;
        margin: 17px;
        width: 90%;
        z-index: 1;
    }

    #messages {
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
        position: absolute;
        overflow-y: scroll;
    }
    .out {
        height: fit-content;
        display: flex;
        padding: 0px 10px;
    }
    .myOut {
        justify-content: end;
    }
    .in {
        display: flex;
        align-items: center;
        width: fit-content;
        border-radius: 10px;
        padding: 0px 10px;
        margin: 10px 1px;
        max-width: 50%;
        word-break: break-all;
    }
    .myIn {
        background-color: rgba(var(--accent-1-strong-rgb), 0.5);
    }
    .botIn {
        background-color: rgba(var(--accent-2-strong-rgb), 0.5);
    }
    .animateFont {
        transition: all .25s var(--transition);
        transform: scaleX(0);
    }
    .anim {
        transform: scaleX(1);
    }
</style>

<div id="messages">
    <div id="messageBubbles"></div>
    <div id="spacer"></div>
</div>
<div class="centre">
    <script>
        insertTemplate(document.currentScript.parentElement, 'chatContainer');

        var CONV = [];

        function makeMessage(role, content, animate = true) {
            var out = document.createElement('div');
            out.classList.add('out');
            var inn = document.createElement('div');
            inn.classList.add('in');
            if (role === 'user') {
                out.classList.add('myOut');
                inn.classList.add('myIn');
            } else {
                inn.classList.add('botIn');
            }
            if (animate) {
                inn.classList.add('animateFont');
                setTimeout(function(){
                    inn.classList.add('anim');
                }, 1)
            }
            var p = document.createElement('p');
            p.innerText = content;
            inn.appendChild(p);
            out.appendChild(inn);
            document.getElementById('messageBubbles').appendChild(out);
            return out;
        }

        async function addMessage(role, content, disableInp = false) {
            var URL = window.location.origin;
            if (!URL.endsWith('/')) {
                URL += '/';
            }
            const ID = this.location.pathname.split('/')[2];
            var newConv = CONV;
            newConv.push({
                'role': role,
                'content': content
            });
            var cont;
            if (disableInp) {
                cont = document.getElementById('chatIn');
                cont.disabled = true;
            }

            resp = await fetch(URL+'api/v1/chat/'+ID, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'conv': CONV
                })
            });
            json = await resp.json();
            if (disableInp) {
                cont.disabled = false;
            }
            if (json.status === 'error') {
                alert(json.message);
                return;
            }
            CONV = json.data.messages;
            if (disableInp) {
                setChatTxt("");
            }
            makeMessage(role, content);
        }

        function scroll() {
            const scrollable = document.getElementById('messages');
            scrollable.scrollTo({ top: scrollable.scrollHeight, behavior: 'smooth' });
        }

        async function runAI() {
            await addMessage('bot', 'Hello, how may I help you?', true);
            scroll();
        }

        async function onChatGo() {
            await addMessage('user', getChatTxt(), true);
            scroll();
            await runAI();
        }

        async function loadData() {
            var URL = window.location.origin;
            if (!URL.endsWith('/')) {
                URL += '/';
            }

            const ID = this.location.pathname.split('/')[2];

            if (ID) {
                var resp = await fetch(URL+'api/v1/chat/'+ID);
                var data = await resp.json();
                if (data.status === 'error') {
                    alert(data.message);
                    home();
                    return;
                }
            } else {
                alert('No chat ID provided');
                home();
                return;
            }
            CONV = data.data.messages;
            CONV.forEach(element => {
                makeMessage(element.role, element.content, false);
            });
            const scrollable = document.getElementById('messages');
            scrollable.scrollTo({ top: scrollable.scrollHeight });
            if (CONV.length < 2) { // First message; came straight from init
                runAI();
            }
        }

        loadData();

        function fix_hei() {
            const cont = document.getElementById('chatContainer');
            const hei = cont.offsetHeight + 54;
            document.getElementById('spacer').style.height = hei + 'px';
        }
        fix_hei();
        document.getElementById('chatIn').oninput = function() {
            fix_hei();
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                onChatGo();
            }
        }
    </script>
</div>
