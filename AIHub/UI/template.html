<!DOCTYPE html>
<head>
    <style>
        :root {
            --hov-rgb: 60, 70, 80;
            --active-rgb: 75, 90, 110;

            --primary-1: rgba(0, 255, 100, 0.07);
            --accent-1-light-rgb: 140, 150, 170;
            --accent-1-dark-rgb: 60, 75, 85;
            --accent-1-strong-rgb: 75, 110, 190;

            --primary-2: rgba(0, 150, 255, 0.1);
            --accent-2-light-rgb: 140, 170, 140;
            --accent-2-dark-rgb: 60, 85, 65;
            --accent-2-strong-rgb: 75, 190, 110;

            --transition: cubic-bezier(.17,.84,.44,1);

            --topbar-height: 76px;
        }

        * {
            font-family: garamund;
        }

        *:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-2-strong-rgb), 0.5);
        }
        .sidebar *:focus {
            box-shadow: 0 0 0 2px rgba(var(--accent-1-strong-rgb), 0.5);
        }
        .noAccent:focus {
            box-shadow: none !important;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
    
        button, *[role="button"] {
            border-radius: 10px;
            border: 0px;
            margin: 8px;
            background-color: rgba(0, 0, 0, 0);
            padding: 10px;
        }
    
        button:hover, *[role="button"]:hover {
            background-color: rgba(var(--hov-rgb), 0.07);
        }
    
        button:active, *[role="button"]:active {
            background-color: rgba(var(--active-rgb), 0.12);
        }

        .visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.4s linear;
        }
        .hidden {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.4s, opacity 0.4s linear;
            pointer-events: none;
        }
        .slightlyHidden {
            opacity: 0.5;
            transition: visibility 0s 0.4s, opacity 0.4s linear;
            pointer-events: none;
        }

        #newChat {
            right: 0;
            position: absolute;
        }

        .sidebar {
            position: relative;
            top: 0;
            z-index: 1;
            background-color: whitesmoke;
        }
        .sidebarTrans {
            transition: all 0.7s var(--transition);
        }
        .sidebarColour {
            background-color: var(--primary-1);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sidebarSegment {
            width: 100%;
        }

        #sideLeft {
            border-right: 2px groove light-dark(rgba(var(--accent-1-light-rgb), 0.7), rgba(var(--accent-1-dark-rgb), 0.7));
            width: 260px;
            min-width: 260px;
            left: 0;
        }
        #sideRight {
            border-left: 2px groove light-dark(rgba(var(--accent-1-light-rgb), 0.7), rgba(var(--accent-1-dark-rgb), 0.7));
            width: 260px;
            min-width: 260px;
            right: 0;
        }
        
        #topBar {
            width: 100vw;
            position: absolute;
            background-color: var(--primary-2);
            height: var(--topbar-height);
            border-bottom: 2px groove light-dark(rgba(var(--accent-2-light-rgb), 0.7), rgba(var(--accent-2-dark-rgb), 0.7));
        }

        #main {
            position: relative;
            height: calc(100vh - var(--topbar-height));
            margin-top: var(--topbar-height);
            flex-grow: 1;
            background-color: var(--primary-2);
        }

        #openSideLeft {
            position: fixed;
        }
        #openSideRight {
            position: fixed;
            right: 0;
        }

        #chatBorder, input {
            background-color: whitesmoke;
            border: 2px solid light-dark(rgba(var(--accent-2-light-rgb), 0.4), rgba(var(--accent-2-dark-rgb), 0.4));
            border-radius: 10px;
            padding: 15px;
            width: 100%;
            accent-color: rgba(var(--accent-2-strong-rgb), 0.5);
            cursor: text;
        }
        #chatBorder:has(*:focus), input:has(*:focus) {
            box-shadow: 0 0 0 2px rgba(var(--accent-2-strong-rgb), 0.5);
        }
        .textarea {
            font-size: 14pt;
            display: block;
            overflow: auto;
            min-height: 40px;
            max-height: 200px;
            align-content: center;
        }

        #renameInp {
            width: calc(100% - (20px * 2));
            margin: 8px;
        }
        
        .placeholder {
            color: gray;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
             -khtml-user-select: none;
               -moz-user-select: none;
                -ms-user-select: none;
                    user-select: none;
        }

        #chatContainer {
            display: flex;
            align-items: stretch;
            gap: 8px;
        }
        #chatIn {
            overflow-y: auto;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        #prevChats {
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .prevChatBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: calc(100% - 8px * 2);
            min-height: 16px;
            padding: 0;
            padding-left: 10px;
        }
        .prevChatBtn > span {
            width: inherit;
        }
        .moreBtn {
            display: flex;
            padding: 0px 10px;
            margin: 0;
            margin-left: 10px;
            flex-shrink: inherit
        }

        #morePage {
            background-color: var(--primary-2);
            border: 2px solid rgba(var(--accent-1-light-rgb), 0.7);
            border-radius: 10px;
            margin: 20px;
            padding: 0px 20px;

            display: grid;
            grid-template-columns: auto auto;
            justify-content: space-between;
        }
        .morePageBtn {
            width: fit-content;
            height: fit-content;
            position: relative;
        }

        #RightSettings {
            width: 100%;
            text-align: center;
            overflow-y: auto;
        }
        #rightCloseButtonContainer {
            width: 100%;
            height: fit-content;
            display: flex;
            justify-content: end;
        }

        select {
            width: calc(100% - 10px);
            padding: 7px;
            margin: 5px 5px;
            background-color: whitesmoke;
            border-radius: 10px;
            border-color: rgba(var(--accent-2-light-rgb), 0.7);
        }

        #AIText {
            font-size: small;
            font-style: italic;
            color: darkslategray;
            margin: 10px;
        }

        .tooltip {
            background-color: black;
            color: white;
            z-index: 2;
            border-radius: 10px;
            visibility: hidden;
            text-align: center;
            padding: 5px;
            position: absolute;
            bottom: 125%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            left: -25%;
            right: -25%;
        }

        *:hover > .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .quote {
            background-color: rgba(125, 125, 125, 0.5);
            border-left: solid 3px rgba(64, 64, 64, 0.8);
            padding-left: 2px;
        }

        .code-inline {
            border: solid 1px rgba(125, 125, 125, 0.25);
            background-color: rgba(125, 125, 125, 0.25);
            border-radius: 5px;
            font-family:'Courier New', Courier, monospace;
            padding: 2px;
        }

        .code-block {
            padding: 15px;
            border-radius: 5px;
            border: solid 2px rgba(125, 125, 125, 0.8);
            padding-top: 5px;
        }
        .code-block .codetop {
            width: calc(100% + 15px);
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .code-block .codelang {
            width: inherit;
            pointer-events: none;
            font-size: small;
        }
        .code-block button {
            margin-top: 0;
            margin-bottom: 5px;
            padding: 5px 10px;
            white-space: nowrap;
        }

        .format-img {
            min-width: 14px;
            min-height: 14px;
        }

        .format-table {
            border-collapse: collapse;
            border-style: hidden;
            border-radius: 5px;
            box-shadow: 0 0 0 1px #666;
        }

        .format-table td {
            border: 1px solid grey;
        }

        .table-top {
            border-bottom: 2px solid black !important;
        }

        #PromptSetts > input[type="number"] {
            width: 80%;
            background-color: whitesmoke;
            padding: 10px;
        }

        .boolLabel {
            display: flex;
            justify-content: center;
        }
        .boolLabel > input[type="checkbox"] {
            width: fit-content;
            margin-left: 20px;
            cursor: pointer;
        }

        .overlay {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            transition: opacity 500ms;
            visibility: hidden;
            opacity: 0;
            z-index: 2;
        }
        .overlay.overlay-open {
            visibility: visible;
            opacity: 1;
        }

        .popup {
            margin: 70px auto;
            padding: 20px;
            background: #fff;
            border-radius: 5px;
            width: 60%;
            height: 70vh;
            overflow: clip;
            position: relative;
        }

        .popup .close {
            position: absolute;
            top: 0;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            text-decoration: none;
            color: #333;
        }
        .popup .close:hover {
            color: #06D85F;
        }

        #popupContent {
            border: solid 1px black;
            border-radius: 5px;
            width: 100%;
            height: calc(100% - 20px);
            top: 20px;
            position: relative;
            overflow: clip;
        }

        .sideAnim {
            width: 0 !important;
            min-width: 0 !important;
            border: none !important;
            pointer-events: none !important;
        }

        #defs {
            display: none !important;
        }
    </style>

    <script>
        var PROVIDER = 'best';
        function encode(str) {
            return encodeURIComponent(str.replace('/', '\\'));
        }
        function copyCodeBlock(elm) {
            navigator.clipboard.writeText(elm.parentElement.parentElement.lastElementChild.innerText.replaceAll(/\s(?<![\n\t\r\f\v ])/g, ' '));
            let origTxt = elm.innerText;
            elm.innerText = '‚úî Copied!';
            setTimeout(()=>{
                elm.innerText = origTxt;
                elm.blur();
            }, 1000)
        }
        function runHTML(elm) {
            const container = document.getElementById('popupContent');
            const shadow = container.attachShadow({ mode: 'closed' });
            const html = document.createElement('html');
            html.innerHTML = elm.parentElement.parentElement.lastElementChild.innerText.replaceAll(/\s(?<![\n\t\r\f\v ])/g, ' ');
            shadow.appendChild(html);
            document.getElementById('popup').classList.add('overlay-open');
        }
        function formatText(elm, str) {
            var safeText = str
                .replaceAll(/&/gm, "&amp;")
                .replaceAll(/</gm, "&lt;")
                .replaceAll(/>/gm, "&gt;")
                .replaceAll(/"/gm, "&quot;")
                .replaceAll(/'/gm, "&#039;");
            
            var blocks = [];
            // TODO: Backslashes
            safeText.split(/^\s*```/gm).forEach((val, idx)=>{
                var newVal;
                if (idx % 2 == 0) {
                    newVal = val
                        .replaceAll(/^(?:(?:\|.*)+\|\n){2,}/gm,
                        (match) => {
                            var spl = match.split('\n');
                            // let weighting = spl[1].split('|'); // TODO
                            var end = '<tr>';
                            spl[0].split('|').forEach(val=>{
                                if (val) {
                                    end += `<td class="table-top"><b>${val}</b></td>`;
                                }
                            });
                            end += '</tr>';
                            spl.slice(2).forEach(row=>{
                                if (row) {
                                    end += '<tr>';
                                    row.split('|').forEach(val=>{
                                        if (val) {
                                            end += `<td>${val}</td>`;
                                        }
                                    });
                                    end += '</tr>';
                                }
                            });

                            return `<table class="format-table">${end}</table>`
                        })
                        .replaceAll(/^(\s*)[-*] (.*)/gm, (_, spaces, content) => {
                            let margin = Math.floor(spaces.replace('\t', '    ').length / 2)*2;
                            return `<ul><li style="margin-left: ${margin}em;">${content}</li></ul>`;
                        })
                        .replaceAll(/<\/ul>\s*<ul>/g, '')
                        .replaceAll(/^(\s*)(\d+)[.) ](.*)/gm, (_, spaces, number, content) => {
                            let margin = Math.floor(spaces.replace('\t', '    ').length / 2)*2;
                            return `<ol><li value="${number}" style="margin-left: ${margin}em;">${content}</li></ol>`;
                        })
                        .replaceAll(/<\/ol>\s*<ol>/g, '')
                        
                        .replaceAll(/!\[(.*)\]\((.*)\)/g, '<img class="format-img" href="$2" alt="$1">')
                        .replaceAll(/\[(.*)\]\((.*)\)/g, '<a href="$2">$1</a>')
                        
                        .replaceAll(/^&gt; ?(.+)\n?/gm, '<span class="quote">$1</span><br>')

                        .replaceAll(/^# ([^\n]*)/gm, '<h1>$1</h1>')
                        .replaceAll(/^## ([^\n]*)/gm, '<h2>$1</h2>')
                        .replaceAll(/^### ([^\n]*)/gm, '<h3>$1</h3>')
                        .replaceAll(/^#### ([^\n]*)/gm, '<h4>$1</h4>')
                        .replaceAll(/^##### ([^\n]*)/gm, '<h5>$1</h5>')
                        .replaceAll(/^###### ([^\n]*)/gm, '<h6>$1</h6>')
                        .replaceAll(/`([^`\n]+)`/g, '<span class="code-inline">$1</span>')

                        .replaceAll(/^[*\-_]{3}$/gm, '<hr>')

                        .replaceAll(/>\n+/gm, '>')
                        .replaceAll('\n</div>', '</div>')

                        .replaceAll(/[*_]{2}((?=[^*_])[^\n<]+(?<=[^*_]))[*_]{2}/g,'<b>$1</b>')
                        .replaceAll(/[*_]((?=[^*_])(?:[^\n<]|(?:<\/?b>))+(?<=[^*_]))[*_]/g, '<i>$1</i>')
                } else {
                    const newlineIndex = val.indexOf('\n');
                    let language = '';
                    let code = val;
                    
                    if (newlineIndex !== -1) {
                        language = val.slice(0, newlineIndex).trim();
                        code = val.slice(newlineIndex + 1);
                    }
                    
                    var btn = '';
                    if (!language) {
                        language = 'plain'
                    } else {
                        const lang = language.toLowerCase().trim();
                        if (lang === "html") {
                            btn = '<button onclick="runHTML(this)">üíªRun code</button>'
                        }
                    }

                    newVal = `<div class="code-block"><div class="codetop"><span class="codelang">${language}</span>${btn}<button onclick="copyCodeBlock(this)">üìãÔ∏è Copy</button></div><div class="code-${language}">${code}</div></div><br>`;
                }
                blocks.push(
                    newVal
                        .replaceAll('\t', '&emsp;')
                        .replaceAll(/^ +/gm, match => '&nbsp;'.repeat(match.length))
                        .replaceAll('\n\n', '<br>')
                        .replaceAll('\n', '<br>')
                )
            })

            elm.innerHTML = blocks.join('');
        }
        function getOpts() {
            var opts = {};
            document.getElementById('PromptSetts').childNodes.forEach(it => {
                var id = it.id;
                if (!id) {
                    if (it.classList.contains('inpParent')) {
                        it = it.lastElementChild;
                        id = it.id;
                    }
                    if (!id) {
                        return;
                    }
                }
                var val;
                switch (it.getAttribute('type')) {
                    case 'checkbox':
                        val = it.value === 'on';
                        break;
                    case 'number':
                        val = parseFloat(it.value);
                        break;
                    case 'choice':
                        var txt = null;
                        it.childNodes.forEach(node=>{
                            if (node.value === it.value) {
                                txt = node.innerText;
                            }
                        });
                        val = [parseInt(it.value), txt];
                        break;
                    default:
                        return;
                }
                opts[id] = val;
            });
            return opts;
        }
        function init() {
            const Chat = document.getElementById("chatIn");
            Chat.addEventListener("paste", function(e) {
                e.preventDefault();
                const pasted = e.clipboardData.getData("text/plain");
                if (!pasted) {
                    return;
                }
                if (Chat.classList.contains("placeholder")) {
                    Chat.textContent = "";
                    Chat.classList.remove("placeholder");
                }
                const sel = window.getSelection();
                if (sel.rangeCount > 0) {
                    let range = sel.getRangeAt(0);
                    // Delete any selected content
                    range.deleteContents();
                    // Create a text node with the pasted content
                    const textNode = document.createTextNode(pasted);
                    // Insert the text node at the caret position
                    range.insertNode(textNode);
                    // Move the caret immediately after the inserted text node
                    range.setStartAfter(textNode);
                    range.collapse(true);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } else {
                    // Fallback: append the text if no caret is found
                    setChatTxt(getChatTxt() + pasted);
                }
                if (getChatTxt() === "") {
                    Chat.classList.add("placeholder");
                }
                if (Chat.classList.contains("placeholder")) {
                    Chat.innerText = Chat.getAttribute("data-placeholder");
                }
            });
            
            var OSL = document.getElementById("openSideLeft");
            OSL.onclick = function() {
                var sideLeft = document.getElementById("sideLeft");
                sideLeft.classList.remove("sideAnim");
                if (OSL.classList.contains("visible")) {
                    OSL.classList.replace("visible", "hidden");
                }
                else {
                    OSL.classList.add("hidden");
                }
                localStorage.setItem('LeftSideOpen', true);
            }

            function CloseLeft() {
                var sideLeft = document.getElementById("sideLeft");
                sideLeft.classList.add("sideAnim");
                if (OSL.classList.contains("hidden")) {
                    OSL.classList.replace("hidden", "visible");
                }
                else {
                    OSL.classList.add("visible");
                }
                localStorage.setItem('LeftSideOpen', false);
            }

            document.getElementById("closeSideLeft").onclick = CloseLeft;
            
            if (localStorage.getItem('LeftSideOpen') === 'false') {
                CloseLeft();
                requestAnimationFrame(function(){
                    sideLeft.style.transition = 'none';
                    // Force reflow
                    void sideLeft.offsetWidth;
                    sideLeft.style.transition = '';
                    sideLeft.classList.add('sidebarTrans');
                });
            } else {
                document.getElementById('sideLeft').classList.add('sidebarTrans');
            }

            var OSR = document.getElementById("openSideRight");
            OSR.onclick = function() {
                var sideRight = document.getElementById("sideRight");
                sideRight.classList.remove("sideAnim");
                if (OSR.classList.contains("visible")) {
                    OSR.classList.replace("visible", "hidden");
                }
                else {
                    OSR.classList.add("hidden");
                }
                localStorage.setItem('RightSideOpen', true);
            }

            function CloseRight() {
                var sideRight = document.getElementById("sideRight");
                sideRight.classList.add("sideAnim");
                if (OSR.classList.contains("hidden")) {
                    OSR.classList.replace("hidden", "visible");
                }
                else {
                    OSR.classList.add("visible");
                }
                localStorage.setItem('RightSideOpen', false);
            }
            document.getElementById("closeSideRight").onclick = CloseRight;

            if (!localStorage.getItem('RightSideOpen') || localStorage.getItem('RightSideOpen') === 'false') {
                CloseRight();
                requestAnimationFrame(function(){
                    sideRight.style.transition = 'none';
                    // Force reflow
                    void sideRight.offsetWidth;
                    sideRight.style.transition = '';
                    sideRight.classList.add('sidebarTrans');
                });
            } else {
                document.getElementById('sideRight').classList.add('sidebarTrans');
            }

            if (!('/'.includes(window.location.pathname))) {
                document.getElementById('newChat').classList.replace('slightlyHidden', 'visible');
            }

            const editable = document.getElementById("chatIn");
            editable.addEventListener("mousedown", function(event) {
                if (this.classList.contains("placeholder")) {
                    event.preventDefault(); // Prevent default caret placement
                    const range = document.createRange();
                    range.setStart(this, 0);
                    range.collapse(true);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });

            function isPrintableKey(event) {
                return event.key.length === 1 && !event.ctrlKey && !event.altKey && !event.metaKey;
            }
            editable.addEventListener("keydown", function() {
                if (this.classList.contains("placeholder")) {
                    if (!isPrintableKey(event)) {
                        return;
                    }
                    this.textContent = "";
                    this.classList.remove("placeholder");
                }
            });
            editable.addEventListener("input", function() {
                if (this.textContent === "") {
                    this.classList.add("placeholder");
                }
                if (this.classList.contains("placeholder")) {
                    this.innerText = this.getAttribute("data-placeholder");
                }
            });
            editable.innerText = editable.getAttribute("data-placeholder");

            parent = document.getElementById('chatBorder');
            parent.onclick = () => {
                const firstChild = parent.firstElementChild;
                if (firstChild) {
                    firstChild.focus();
                }
            };

            function UpdateText() {
                fetch('/api/v1/ai/info/'+encode(PROVIDER))
                    .then(resp => resp.json())
                    .then(data => {
                        formatText(document.getElementById('AIText'), data.data);
                    });
            }

            fetch('/api/v1/ai/get')
                .then(resp => resp.json())
                .then(data => {
                    const modeSels = document.getElementById('AIDropdowns');
                    function hierachyBranch(branch, befores, prov, restoreBranch=null) {
                        var select = document.createElement('select');
                        select.onchange = function() {
                            var times = modeSels.children.length-befores-1
                            for (i = 0;i < times; i++) {
                                modeSels.removeChild(modeSels.children[befores+1]);
                            }
                            if (!isNaN(this.value) && !isNaN(parseFloat(this.value))) {
                                const val = branch[this.value];
                                if (val[0].includes('<*sep*>')) {
                                    PROVIDER = prov+val[0].split('<*sep*>')[1]+':';
                                } else {
                                    PROVIDER = prov+val[0]+':';
                                }
                                hierachyBranch(val[1], befores+1, PROVIDER);
                                PROVIDER += 'best';
                            } else {
                                PROVIDER = prov+this.value;
                            }
                            loadOpts();
                            UpdateText();
                            localStorage.setItem('hierachy', PROVIDER);
                            this.blur();
                        };
                        ['best', 'random'].forEach(val => {
                            var optionA = document.createElement('option');
                            optionA.value = val;
                            optionA.textContent = val;
                            select.appendChild(optionA);
                        });
                        
                        var group = document.createElement('optgroup');
                        group.label = 'Provider choices:';
                        branch.forEach((val, idx) => {
                            var option = document.createElement('option');
                            if (Array.isArray(val)) {
                                option.value = idx;
                                if (val[0].includes('<*sep*>')) {
                                    option.textContent = val[0].split('<*sep*>')[0] + ' ...';
                                } else {
                                    option.textContent = val[0] + ' ...';
                                }
                            } else {
                                if (val.includes('<*sep*>')) {
                                    let sep = val.split('<*sep*>');
                                    option.value = sep[1];
                                    option.textContent = sep[0];
                                } else {
                                    option.value = val;
                                    option.textContent = val;
                                }
                            }
                            group.appendChild(option);
                        });
                        select.appendChild(group);
                        modeSels.appendChild(select);

                        if (restoreBranch) {
                            var colIdx = restoreBranch.indexOf(':');
                            if (colIdx !== -1) {
                                let bef = restoreBranch.slice(0, colIdx);
                                let aft = restoreBranch.slice(colIdx+1);
                                let idx = branch.findIndex(val => {
                                    if (!Array.isArray(val)) {
                                        return false;
                                    }
                                    if (val[0].includes('<*sep*>')) {
                                        return val[0].split('<*sep*>')[1] === bef;
                                    } else {
                                        return val[0] === bef;
                                    }
                                    
                                });
                                select.value = idx;
                                hierachyBranch(branch[idx][1], befores+1, prov+bef+':', aft);
                            } else {
                                select.value = restoreBranch;
                            }
                        }
                    }
                    if (localStorage.getItem('hierachy')) {
                        PROVIDER = localStorage.getItem('hierachy');
                    }
                    hierachyBranch(data.data, 0, '', localStorage.getItem('hierachy'));
                    loadOpts();
                    UpdateText();
                });
        }

        async function loadOpts() {
            const opts = document.getElementById('PromptSetts');
            const leng = opts.children.length;
            for (i = 0;i < leng;i++) {
                opts.removeChild(opts.firstElementChild);
            }
            resp = await fetch('/api/v1/ai/opts/'+encode(PROVIDER));
            json = await resp.json();
            json.opts.forEach(it => {
                const id = it.id || '';
                switch(it.type) {
                    case 'header':
                        const header = document.createElement('h4');
                        header.id = id;
                        header.innerText = it.label;
                        opts.appendChild(header);
                        break;
                    case 'numInp':
                        var labelElem = document.createElement('label');
                        labelElem.innerText = it.label;
                        opts.appendChild(labelElem);
                        const numInput = document.createElement('input');
                        numInput.id = id;
                        numInput.type = 'number';
                        numInput.defaultValue = it.default;
                        numInput.min = it.min;
                        numInput.max = it.max;
                        numInput.step = it.step || 1;
                        opts.appendChild(numInput);
                        break;
                    case 'boolInp':
                        const boolLabel = document.createElement('div');
                        boolLabel.classList.add('boolLabel');
                        boolLabel.classList.add('inpParent');
                        const label = document.createElement('p');
                        label.innerText = it.label;
                        boolLabel.appendChild(label);
                        const boolInput = document.createElement('input');
                        boolInput.id = id;
                        boolInput.type = 'checkbox';
                        boolInput.checked = it.default;
                        boolLabel.appendChild(boolInput);
                        opts.appendChild(boolLabel);
                        break;
                    case 'choiceInp':
                        var labelElem = document.createElement('label');
                        labelElem.innerText = it.label;
                        opts.appendChild(labelElem);
                        const choiceInp = document.createElement('select');
                        choiceInp.id = id;
                        choiceInp.setAttribute('type', 'choice');
                        it.choices.forEach((txt, idx) => {
                            var choice = document.createElement('option');
                            choice.value = idx;
                            choice.innerText = txt;
                            choiceInp.appendChild(choice);
                        });
                        choiceInp.value = it.default;
                        opts.appendChild(choiceInp);
                        break;
                    default:
                        console.error(`Unknown type ${it.type}`)
                }
            });
        }

        function closePopup() {
            document.getElementById('popup').classList.remove('overlay-open');
            var popupC = document.getElementById('popupContent');
            var parent = popupC.parentElement;
            parent.removeChild(popupC);
            var newdiv = document.createElement('div');
            newdiv.id = 'popupContent';
            parent.appendChild(newdiv);
        }

        function home() {
            if (!('/'.includes(window.location.pathname))) {
                window.location = '/';
            }
        }

        function getChatTxt() {
            const chatBox = document.getElementById('chatIn');
            if (chatBox.classList.contains('placeholder')) {
                return "";
            }
            return chatBox.innerText;
        }
        function setChatTxt(txt) {
            const chatBox = document.getElementById('chatIn');
            if (txt === "") {
                chatBox.classList.add('placeholder');
                chatBox.innerText = chatBox.getAttribute("data-placeholder");
            } else {
                chatBox.classList.remove('placeholder');
                chatBox.innerText = txt;
            }
        }

        var SELECTED = null;
        function findConvs() {
            fetch('/api/v1/chat')
                .then(resp => resp.json())
                .then(json => {
                    if (json.status === 'error') {
                        console.error(json);
                        alert(json.message);
                        return;
                    }
                    const data = json.data;
                    const parent = document.getElementById('prevChats');
                    const len = parent.childNodes.length;
                    for (i = 0;i < len;i++) {
                        parent.removeChild(parent.firstChild);
                    }
                    data.forEach(element => {
                        var parentDiv = copyTemplate('PrevChatBtn');
                        var button = parentDiv.firstElementChild;
                        button.onclick = function() {
                            window.location = '/chat/'+element[0];
                        }
                        button.firstElementChild.innerText = element[1];

                        var btn2 = button.lastElementChild;

                        btn2.onclick = function(event) {
                            event.stopPropagation();
                            const MP = document.getElementById('morePage');
                            if (MP.parentElement.id !== "defs" && (!MP.contains(event.target)) && parentDiv.contains(MP)) {
                                unuseTemplate('morePage');
                            } else {
                                unuseTemplate('renameInp')
                                insertTemplate(parentDiv, 'morePage');
                                SELECTED = element[0];
                            }
                        };

                        parent.appendChild(parentDiv);
                    });
                });
        }
        findConvs();

        function deleteConv() {
            if (SELECTED === null || !confirm('Are you sure you want to delete this chat?')) {
                return;
            }
            fetch('/api/v1/chat/'+SELECTED, {
                method: 'DELETE'
            })
                .then(resp => resp.json())
                .then(json => {
                    if (json.status === 'error') {
                        console.error(json);
                        alert(json.message);
                        return;
                    }
                    if (window.location.pathname === "/chat/"+SELECTED) {
                        window.location.replace('/');
                    }
                    unuseTemplate('morePage');
                    findConvs();
                });
        }
        
        function renameConv() {
            const parent = document.getElementById('morePage').parentElement;
            unuseTemplate('morePage');
            const inp = insertTemplate(parent, 'renameInp');
            inp.value = "";
            inp.placeholder = parent.firstElementChild.firstElementChild.innerText;
            inp.focus();
            inp.onblur = function() {
                if (inp.value === "") {
                    inp.onblur = function() {};
                    unuseTemplate('renameInp');
                    return;
                }
                fetch('/api/v1/chat/'+SELECTED, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': "application/json"
                    },
                    body: JSON.stringify({'name': inp.value})
                })
                    .then(resp => resp.json())
                    .then(json => {
                        if (json.status === 'error') {
                            console.error(json);
                            alert(json.message);
                            return;
                        }
                        parent.firstElementChild.firstElementChild.innerText = inp.value;
                        inp.onblur = function() {};
                        unuseTemplate('renameInp');
                    });
            }
        }

        document.addEventListener('click', function(event) {
            if (event.target.closest('.moreBtn')) {
                return;
            }

            document.querySelectorAll('select').forEach(function(select) {
                if (!select.contains(event.target)) {
                    select.blur();
                }
            });

            const MP = document.getElementById('morePage');
            if (MP.parentElement.id !== "defs" && (!MP.contains(event.target))) {
                unuseTemplate('morePage');
            }
        });

        function insertTemplate(obj, id) {
            const templ = document.getElementById(id);
            obj.appendChild(templ);
            return templ;
        }

        function copyTemplate(id) {
            const newElm = document.getElementById(id).cloneNode(true);
            newElm.removeAttribute('id');
            return newElm;
        }

        function unuseTemplate(id) {
            var obj = document.getElementById(id);
            const defs = document.getElementById('defs');
            defs.appendChild(obj);
        }

        function onChatGo() {} // For overriding
    </script>
</head>
<body onload="init()">
    <div id="defs">
        <svg>
            <defs>
                <symbol id="sideLeftIcon" viewBox="0 0 26 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="22" height="20" rx="5" ry="5"/>
                    <path d="M6 7 H7" stroke-width="2"/>
                    <path d="M6 10 H7" stroke-width="2"/>
                    <path d="M6 13 H7" stroke-width="2"/>
                    <path d="M11 22V2"/>
                </symbol>

                <symbol id="sideRightIcon" viewBox="0 0 26 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="22" height="20" rx="5" ry="5"/>
                    <path d="M20 7 H19" stroke-width="2"/>
                    <path d="M20 10 H19" stroke-width="2"/>
                    <path d="M20 13 H19" stroke-width="2"/>
                    <path d="M15 22V2"/>
                </symbol>

                <symbol id="more" viewbox="0 0 100 100">
                    <circle cx="20" cy="50" r="7" fill="black"/>
                    <circle cx="50" cy="50" r="7" fill="black"/>
                    <circle cx="80" cy="50" r="7" fill="black"/>
                </symbol>

                <symbol id="delete" viewBox="0 0 24 24" fill="none">
                    <g stroke="#e01b24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 11V17" />
                        <path d="M14 11V17" />
                        <path d="M4 7H20" />
                        <path d="M6 7H12H18V18C18 19.6569 16.6569 21 15 21H9C7.34315 21 6 19.6569 6 18V7Z" />
                        <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" />
                    </g>
                </symbol>
                <symbol id="backspace" viewBox="0 0 24 24" fill="none">
                    <path d="M11 10L15 14M11 14L15 10M2.7716 13.5185L7.43827 17.5185C7.80075 17.8292 8.26243 18 8.73985 18H18C19.1046 18 20 17.1046 20 16V8C20 6.89543 19.1046 6 18 6H8.73985C8.26243 6 7.80075 6.17078 7.43827 6.48149L2.7716 10.4815C1.84038 11.2797 1.84038 12.7203 2.7716 13.5185Z" stroke="#000000" stroke-width="2.16" stroke-linecap="round" stroke-linejoin="round" />
                </symbol>

                <symbol id="rename" viewBox="0 -0.5 21 21">
                    <path fill="#000" transform="translate(-283, -640)" d="M286.15,654 C285.57,654 285.1,653.552 285.1,653 L285.1,647 C285.1,646.448 285.57,646 286.15,646 C286.73,646 287.2,645.552 287.2,645 C287.2,644.448 286.73,644 286.15,644 L285.1,644 C283.94,644 283,644.895 283,646 L283,654 C283,655.105 283.94,656 285.1,656 L286.15,656 C286.73,656 287.2,655.552 287.2,655 C287.2,654.448 286.73,654 286.15,654 M301.9,644 L294.55,644 C293.97,644 293.5,644.448 293.5,645 C293.5,645.552 293.97,646 294.55,646 L300.85,646 C301.43,646 301.9,646.448 301.9,647 L301.9,653 C301.9,653.552 301.43,654 300.85,654 L294.55,654 C293.97,654 293.5,654.448 293.5,655 C293.5,655.552 293.97,656 294.55,656 L301.9,656 C303.06,656 304,655.105 304,654 L304,646 C304,644.895 303.06,644 301.9,644 M293.5,659 C293.5,659.552 293.03,660 292.45,660 L288.25,660 C287.67,660 287.2,659.552 287.2,659 C287.2,658.448 287.67,658 288.25,658 L289.3,658 L289.3,642 L288.25,642 C287.67,642 287.2,641.552 287.2,641 C287.2,640.448 287.67,640 288.25,640 L292.45,640 C293.03,640 293.5,640.448 293.5,641 C293.5,641.552 293.03,642 292.45,642 L291.4,642 L291.4,658 L292.45,658 C293.03,658 293.5,658.448 293.5,659" />
                </symbol>

                <symbol id="share" viewBox="0 0 24 24" fill="none" stroke="#000" stroke-width="1.5">
                    <path d="M9 12C9 13.3807 7.88071 14.5 6.5 14.5C5.11929 14.5 4 13.3807 4 12C4 10.6193 5.11929 9.5 6.5 9.5C7.88071 9.5 9 10.6193 9 12Z" />
                    <path d="M14 6.5L9 10" stroke-linecap="round"/>
                    <path d="M14 17.5L9 14" stroke-linecap="round"/>
                    <path d="M19 18.5C19 19.8807 17.8807 21 16.5 21C15.1193 21 14 19.8807 14 18.5C14 17.1193 15.1193 16 16.5 16C17.8807 16 19 17.1193 19 18.5Z" />
                    <path d="M19 5.5C19 6.88071 17.8807 8 16.5 8C15.1193 8 14 6.88071 14 5.5C14 4.11929 15.1193 3 16.5 3C17.8807 3 19 4.11929 19 5.5Z" />
                </symbol>

                <symbol id="redo" viewBox="-2 0 24 24">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M14.3787 7L12.9393 8.43934C12.3536 9.02513 12.3536 9.97487 12.9393 10.5607C13.5251 11.1464 14.4749 11.1464 15.0607 10.5607L19.0607 6.56066C19.6464 5.97487 19.6464 5.02513 19.0607 4.43934L15.0607 0.43934C14.4749 -0.146447 13.5251 -0.146447 12.9393 0.43934C12.3536 1.02513 12.3536 1.97487 12.9393 2.56066L14.3787 4H10C4.47715 4 0 8.47715 0 14C0 19.5228 4.47715 24 10 24C15.5228 24 20 19.5228 20 14C20 13.1716 19.3284 12.5 18.5 12.5C17.6716 12.5 17 13.1716 17 14C17 17.866 13.866 21 10 21C6.13401 21 3 17.866 3 14C3 10.134 6.13401 7 10 7H14.3787z" fill="#000000"/>
                </symbol>

                <symbol id="editText" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.2799 6.40005L11.7399 15.94C10.7899 16.89 7.96987 17.33 7.33987 16.7C6.70987 16.07 7.13987 13.25 8.08987 12.3L17.6399 2.75002C17.8754 2.49308 18.1605 2.28654 18.4781 2.14284C18.7956 1.99914 19.139 1.92124 19.4875 1.9139C19.8359 1.90657 20.1823 1.96991 20.5056 2.10012C20.8289 2.23033 21.1225 2.42473 21.3686 2.67153C21.6147 2.91833 21.8083 3.21243 21.9376 3.53609C22.0669 3.85976 22.1294 4.20626 22.1211 4.55471C22.1128 4.90316 22.0339 5.24635 21.8894 5.5635C21.7448 5.88065 21.5375 6.16524 21.2799 6.40005V6.40005Z" />
                    <path d="M11 4H6C4.93913 4 3.92178 4.42142 3.17163 5.17157C2.42149 5.92172 2 6.93913 2 8V18C2 19.0609 2.42149 20.0783 3.17163 20.8284C3.92178 21.5786 4.93913 22 6 22H17C19.21 22 20 20.2 20 18V13" />
                </symbol>

                <symbol id="go" fill="none" fill-rule="nonzero">
                    <path d="M24 0v24H0V0h24ZM12.593 23.258l-.011.002-.071.035-.02.004-.014-.004-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01-.017.428.005.02.01.013.104.074.015.004.012-.004.104-.074.012-.016.004-.017-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113-.013.002-.185.093-.01.01-.003.011.018.43.005.012.008.007.201.093c.012.004.023 0 .029-.008l.004-.014-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014-.034.614c0 .012.007.02.017.024l.015-.002.201-.093.01-.008.004-.011.017-.43-.003-.012-.01-.01-.184-.092Z"/>
                    <path fill="#09244B" d="M20.25 3.532a1 1 0 0 1 1.183 1.329l-6 15.5a1 1 0 0 1-1.624.362l-3.382-3.235-1.203 1.202c-.636.636-1.724.186-1.724-.714v-3.288L2.309 9.723a1 1 0 0 1 .442-1.691l17.5-4.5Zm-2.114 4.305-7.998 6.607 3.97 3.798 4.028-10.405Zm-1.578-1.29L4.991 9.52l3.692 3.53 7.875-6.505Z"/>
                </symbol>
                <symbol id="stop" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12C3 16.9706 7.02944 21 12 21C16.9706 21 21 16.9706 21 12C21 7.02944 16.9706 3 12 3C7.02944 3 3 7.02944 3 12Z" />
                    <path d="M15 13.3996V10.5996C15 10.0396 14.9996 9.75981 14.8906 9.5459C14.7948 9.35774 14.6423 9.20487 14.4542 9.10899C14.2403 9 13.9597 9 13.3996 9H10.5996C10.0396 9 9.75981 9 9.5459 9.10899C9.35774 9.20487 9.20487 9.35774 9.10899 9.5459C9 9.75981 9 10.0396 9 10.5996V13.3996C9 13.9597 9 14.2403 9.10899 14.4542C9.20487 14.6423 9.35774 14.7948 9.5459 14.8906C9.75981 14.9996 10.0396 15 10.5996 15H13.3996C13.9597 15 14.2403 14.9996 14.4542 14.8906C14.6423 14.7948 14.7948 14.6423 14.8906 14.4542C14.9996 14.2403 15 13.9597 15 13.3996Z" />
                </symbol>
            </defs>
        </svg>
        <svg id="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="42.83 20">
            <animate attributeName="stroke-dashoffset" from="0" to="62.83" dur="2s" repeatCount="indefinite" />
            <animate attributeName="stroke-dasharray" values="42.83 20;20 42.83;42.83 20" dur="2s" repeatCount="indefinite" />
          </circle>
        </svg>
        <div id="chatContainer">
            <div id="chatBorder">
                <span id="chatIn" data-placeholder="Message an AI" class="textarea placeholder noAccent" role="textbox" name="chatIn" onkeydown="if(event.key === 'Enter' && !event.shiftKey) {event.preventDefault();onChatGo()}" onselectstart="return !this.classList.contains('placeholder');" contenteditable></span>
            </div>
            <button id="chatGoBtn" onclick="onChatGo()">
                <svg width="24" height="24">
                    <use href="#go" />
                </svg>
            </button>
        </div>
        <div id="PrevChatBtn">
            <button class="prevChatBtn">
                <span></span>
                <div class="moreBtn" role="button" tabindex="0">
                    <svg class="moreBtnSvg" height="38" width="30">
                        <use href="#more"/>
                    </svg>
                    <div class="tooltip">Options</div>
                </div>
            </button>
        </div>
        <input id="renameInp" type="text" onkeydown="if(event.key === 'Enter') {this.blur();}"></input>
        <div id="morePage">
            <div class="morePageBtn" role="button" tabindex="0">
                <svg height="38" width="30">
                    <use href="#share"/>
                </svg>
                <div class="tooltip">Share</div>
            </div>
            <div class="morePageBtn" role="button" tabindex="0" onclick="renameConv()">
                <svg height="38" width="30">
                    <use href="#rename"/>
                </svg>
                <div class="tooltip">Rename</div>
            </div>
            <div class="morePageBtn" role="button" tabindex="0" onclick="deleteConv()">
                <svg height="38" width="30">
                    <use href="#delete"/>
                </svg>
                <div class="tooltip" style="color: red">Delete</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="sideLeft" class="sidebar">
            <div class="sidebarColour">
                <button id="closeSideLeft" class="noAccent">
                    <svg width="36" height="36">
                        <use href="#sideLeftIcon"/>
                    </svg>
                </button>
                <button id="newChat" class="slightlyHidden" onclick="home()">
                    <svg fill="none" width="36" height="36" viewBox="0 0 48 48" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20"/>
                        <path d="M24 14V34"/>
                        <path d="M14 24H34"/>
                    </svg>
                </button>
                <div id="prevChats" class="sidebarSegment"></div>
            </div>
        </div>
        <div id="topBar">
            <button id="openSideLeft" class="noAccent hidden">
                <svg width="36" height="36">
                    <use href="#sideLeftIcon"/>
                </svg>  
            </button>
        
            <button id="openSideRight" class="noAccent hidden">
                <svg width="36" height="36">
                    <use href="#sideRightIcon"/>
                </svg>  
            </button>
        </div>
        <div id="main"><!-- INSERT CODE --></div>
        <div id="sideRight" class="sidebar">
            <div class="sidebarColour">
                <div id="rightCloseButtonContainer">
                    <button id="closeSideRight" class="noAccent">
                        <svg width="36" height="36">
                            <use href="#sideRightIcon"/>
                        </svg>
                    </button>
                </div>
                <div id="RightSettings">
                    <h2>Chatbot</h2>
                    <p>AI Service:</p>
                    <div id="AIDropdowns"></div>
                    <p id="AIText"></p>
                    <hr>
                    <h2>Prompt settings</h2>
                    <div id="PromptSetts"></div>
                    <br><br>
                </div>
            </div>
        </div>
    </div>

    <div id="popup" class="overlay">
        <div class="popup">
            <a class="close" onclick="closePopup()">&times;</a>
            <div id="popupContent"></div>
        </div>
    </div>
</body>