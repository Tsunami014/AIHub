<!DOCTYPE html>
<head>
    <style>
        :root {
            --hov-col: rgba(60, 70, 80, 0.07);
            --active-col: rgba(75, 90, 110, 0.12);

            --primary-1: rgba(0, 255, 100, 0.1);
            --accent-1-light-rgb: 140, 150, 170;
            --accent-1-dark-rgb: 60, 75, 85;
            --accent-1-strong-rgb: 75, 110, 190;

            --primary-2: rgba(0, 150, 255, 0.1);
            --accent-2-light-rgb: 140, 170, 140;
            --accent-2-dark-rgb: 60, 85, 65;
            --accent-2-strong-rgb: 75, 190, 110;

            --transition: cubic-bezier(.17,.84,.44,1);

            --topbar-height: 76px;
        }

        * {
            font-family: garamund;
        }

        *:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(var(--accent-2-strong-rgb), 0.5);
        }
        .sidebar *:focus {
            box-shadow: 0 0 0 2px rgba(var(--accent-1-strong-rgb), 0.5);
        }
        .noAccent:focus {
            box-shadow: none !important;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
    
        button, *[role="button"] {
            border-radius: 10px;
            border: 0px;
            margin: 8px;
            background-color: rgba(0, 0, 0, 0);
            padding: 10px;
        }
    
        button:hover, *[role="button"]:hover {
            background-color: var(--hov-col);
        }
    
        button:active, *[role="button"]:active {
            background-color: var(--active-col);
        }

        .visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.4s linear;
        }
        .hidden {
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s 0.4s, opacity 0.4s linear;
            pointer-events: none;
        }
        .slightlyHidden {
            opacity: 0.5;
            transition: visibility 0s 0.4s, opacity 0.4s linear;
            pointer-events: none;
        }

        #newChat {
            right: 0;
            position: absolute;
        }

        .sidebar {
            position: relative;
            top: 0;
            z-index: 2;
            background-color: whitesmoke;
        }
        .sidebarTrans {
            transition: width 0.7s var(--transition);
        }
        .sidebarColour {
            background-color: var(--primary-1);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .sidebarSegment {
            width: 100%;
        }

        #sideLeft {
            border-right: 2px groove light-dark(rgba(var(--accent-1-light-rgb), 0.7), rgba(var(--accent-1-dark-rgb), 0.7));
            width: 260px;
            left: 0;
        }
        #sideRight {
            border-left: 2px groove light-dark(rgba(var(--accent-1-light-rgb), 0.7), rgba(var(--accent-1-dark-rgb), 0.7));
            width: 260px;
            right: 0;
        }
        
        #topBar {
            width: 100vw;
            position: absolute;
            background-color: var(--primary-2);
            height: var(--topbar-height);
            border-bottom: 2px groove light-dark(rgba(var(--accent-2-light-rgb), 0.7), rgba(var(--accent-2-dark-rgb), 0.7));
        }

        #main {
            position: relative;
            height: calc(100vh - var(--topbar-height));
            margin-top: var(--topbar-height);
            flex-grow: 1;
            background-color: var(--primary-2);
        }

        #openSideLeft {
            position: fixed;
        }
        #openSideRight {
            position: fixed;
            right: 0;
        }

        #chatBorder {
            background-color: whitesmoke;
            border: 2px solid light-dark(rgba(var(--accent-2-light-rgb), 0.4), rgba(var(--accent-2-dark-rgb), 0.4));
            border-radius: 10px;
            padding: 10px 10px;
            width: 100%;
            accent-color: rgba(var(--accent-2-strong-rgb), 0.5);
            cursor: text;
        }
        #chatBorder:has(*:focus) {
            box-shadow: 0 0 0 2px rgba(var(--accent-2-strong-rgb), 0.5);
        }
        .textarea {
            font-size: 14pt;
            display: block;
            overflow: auto;
            min-height: 40px;
            max-height: 200px;
            align-content: center;
        }
        .placeholder {
            color: gray;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
             -khtml-user-select: none;
               -moz-user-select: none;
                -ms-user-select: none;
                    user-select: none;
        }

        #chatContainer {
            display: flex;
            align-items: stretch;
            gap: 8px;
        }
        #chatIn {
            flex: 1;
        }

        #prevChats {
            height: 100%;
            overflow-y: scroll;
            display: flex;
            flex-direction: column;
        }

        .prevChatBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: calc(100% - 8px * 2);
        }
        .moreBtn {
            position: absolute;
            display: flex;
            right: 0;
            padding: 0px 10px;
        }

        #morePage {
            background-color: white;
            border: 2px solid rgba(var(--accent-1-light-rgb), 0.7);
            border-radius: 10px;
            margin: 20px;
            padding: 1px 15px;
        }

        #RightSettings {
            width: 100%;
            text-align: center;
        }
        #rightCloseButtonContainer {
            width: 100%;
            height: fit-content;
            display: flex;
            justify-content: end;
        }

        select {
            width: calc(100% - 10px);
            padding: 7px;
            margin: 5px 5px;
            background-color: whitesmoke;
            border-radius: 10px;
            border-color: rgba(var(--accent-2-light-rgb), 0.7);
        }

        #AIText {
            font-size: small;
            font-style: italic;
            color: darkslategray;
            margin: 10px;
        }


        .sideAnim {
            width: 0 !important;
            border: none !important;
            pointer-events: none !important;
        }

        #defs {
            display: none !important;
        }
    </style>

    <script>
        var PROVIDER = 'best';
        function init() {
            var OSL = document.getElementById("openSideLeft");
            OSL.onclick = function() {
                var sideLeft = document.getElementById("sideLeft");
                sideLeft.classList.remove("sideAnim");
                if (OSL.classList.contains("visible")) {
                    OSL.classList.replace("visible", "hidden");
                }
                else {
                    OSL.classList.add("hidden");
                }
                localStorage.setItem('LeftSideOpen', true);
            }

            function CloseLeft() {
                var sideLeft = document.getElementById("sideLeft");
                sideLeft.classList.add("sideAnim");
                if (OSL.classList.contains("hidden")) {
                    OSL.classList.replace("hidden", "visible");
                }
                else {
                    OSL.classList.add("visible");
                }
                localStorage.setItem('LeftSideOpen', false);
            }

            document.getElementById("closeSideLeft").onclick = CloseLeft;
            
            if (localStorage.getItem('LeftSideOpen') === 'false') {
                CloseLeft();
                requestAnimationFrame(function(){
                    sideLeft.style.transition = 'none';
                    // Force reflow
                    void sideLeft.offsetWidth;
                    sideLeft.style.transition = '';
                    sideLeft.classList.add('sidebarTrans');
                });
            } else {
                document.getElementById('sideLeft').classList.add('sidebarTrans');
            }

            var OSR = document.getElementById("openSideRight");
            OSR.onclick = function() {
                var sideRight = document.getElementById("sideRight");
                sideRight.classList.remove("sideAnim");
                if (OSR.classList.contains("visible")) {
                    OSR.classList.replace("visible", "hidden");
                }
                else {
                    OSR.classList.add("hidden");
                }
                localStorage.setItem('RightSideOpen', true);
            }

            function CloseRight() {
                var sideRight = document.getElementById("sideRight");
                sideRight.classList.add("sideAnim");
                if (OSR.classList.contains("hidden")) {
                    OSR.classList.replace("hidden", "visible");
                }
                else {
                    OSR.classList.add("visible");
                }
                localStorage.setItem('RightSideOpen', false);
            }
            document.getElementById("closeSideRight").onclick = CloseRight;

            if (!localStorage.getItem('RightSideOpen') || localStorage.getItem('RightSideOpen') === 'false') {
                CloseRight();
                requestAnimationFrame(function(){
                    sideRight.style.transition = 'none';
                    // Force reflow
                    void sideRight.offsetWidth;
                    sideRight.style.transition = '';
                    sideRight.classList.add('sidebarTrans');
                });
            } else {
                document.getElementById('sideRight').classList.add('sidebarTrans');
            }

            if (!('/'.includes(window.location.pathname))) {
                document.getElementById('newChat').classList.replace('slightlyHidden', 'visible');
            }

            const editable = document.getElementById("chatIn");
            editable.addEventListener("mousedown", function(event) {
                if (this.classList.contains("placeholder")) {
                    event.preventDefault(); // Prevent default caret placement
                    const range = document.createRange();
                    range.setStart(this, 0);
                    range.collapse(true);
                    const sel = window.getSelection();
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            });

            function isPrintableKey(event) {
                return event.key.length === 1 && !event.ctrlKey && !event.altKey && !event.metaKey;
            }
            editable.addEventListener("keydown", function() {
                if (this.classList.contains("placeholder")) {
                    if (!isPrintableKey(event)) {
                        return;
                    }
                    this.textContent = "";
                    this.classList.remove("placeholder");
                }
            });
            editable.addEventListener("input", function() {
                if (this.textContent === "") {
                    this.classList.add("placeholder");
                }
                if (this.classList.contains("placeholder")) {
                    this.innerText = this.getAttribute("data-placeholder");
                }
            });
            editable.innerText = editable.getAttribute("data-placeholder");

            parent = document.getElementById('chatBorder');
            parent.onclick = () => {
                const firstChild = parent.firstElementChild;
                if (firstChild) {
                    firstChild.focus();
                }
            };

            function UpdateText() {
                fetch('/api/v1/ai/info/'+PROVIDER)
                    .then(resp => resp.json())
                    .then(data => {
                        document.getElementById('AIText').innerText = data.data;
                    });
            }

            fetch('/api/v1/ai/get')
                .then(resp => resp.json())
                .then(data => {
                    const modeSels = document.getElementById('AIDropdowns');
                    function hierachyBranch(branch, befores, prov, restoreBranch=null) {
                        var select = document.createElement('select');
                        select.onchange = function() {
                            var times = modeSels.children.length-befores-1
                            for (i = 0;i < times; i++) {
                                modeSels.removeChild(modeSels.children[befores+1]);
                            }
                            if (!isNaN(this.value) && !isNaN(parseFloat(this.value))) {
                                const val = branch[this.value]
                                PROVIDER = prov+val[0]+':';
                                hierachyBranch(val[1], befores+1, PROVIDER);
                                PROVIDER += 'best';
                            } else {
                                PROVIDER = prov+this.value;
                            }
                            UpdateText();
                            localStorage.setItem('hierachy', PROVIDER);
                            this.blur();
                        };
                        ['best', 'random'].forEach(val => {
                            var optionA = document.createElement('option');
                            optionA.value = val;
                            optionA.textContent = val;
                            select.appendChild(optionA);
                        });
                        
                        var group = document.createElement('optgroup');
                        group.label = 'Provider choices:';
                        branch.forEach((val, idx) => {
                            var option = document.createElement('option');
                            if (Array.isArray(val)) {
                                option.value = idx;
                                option.textContent = val[0] + ' ...';
                            } else {
                                option.value = val;
                                option.textContent = val;
                            }
                            group.appendChild(option);
                        });
                        select.appendChild(group);
                        modeSels.appendChild(select);

                        if (restoreBranch) {
                            var colIdx = restoreBranch.indexOf(':');
                            if (colIdx !== -1) {
                                let bef = restoreBranch.slice(0, colIdx);
                                let aft = restoreBranch.slice(colIdx+1);
                                let idx = branch.findIndex(val => val[0] === bef);
                                select.value = idx;
                                hierachyBranch(branch[idx][1], befores+1, prov+bef+':', aft);
                            } else {
                                select.value = restoreBranch;
                            }
                        }
                    }
                    if (localStorage.getItem('hierachy')) {
                        PROVIDER = localStorage.getItem('hierachy');
                    }
                    hierachyBranch(data.data, 0, '', localStorage.getItem('hierachy'));
                    UpdateText();
                })
        }

        function home() {
            if (!('/'.includes(window.location.pathname))) {
                window.location.replace('/');
            }
        }

        function getChatTxt() {
            const chatBox = document.getElementById('chatIn');
            if (chatBox.classList.contains('placeholder')) {
                return "";
            }
            return chatBox.innerText;
        }
        function setChatTxt(txt) {
            const chatBox = document.getElementById('chatIn');
            if (txt === "") {
                chatBox.classList.add('placeholder');
                chatBox.innerText = chatBox.getAttribute("data-placeholder");
            } else {
                chatBox.classList.remove('placeholder');
                chatBox.innerText = txt;
            }
        }

        function findConvs() {
            fetch('/api/v1/chat')
                .then(resp => resp.json())
                .then(json => {
                    if (json.status === 'error') {
                        console.error(json);
                        alert(json.message);
                        return;
                    }
                    const data = json.data;
                    const parent = document.getElementById('prevChats');
                    data.forEach(element => {
                        var parentDiv = copyTemplate('PrevChatBtn');
                        var button = parentDiv.firstElementChild;
                        button.onclick = function() {
                            window.location.replace('/chat/'+element[0]);
                        }
                        button.firstElementChild.innerText = element[1];

                        var btn2 = button.lastElementChild;

                        btn2.onclick = function(event) {
                            event.stopPropagation();
                            const MP = document.getElementById('morePage');
                            if (MP.parentElement.id !== "defs" && (!MP.contains(event.target)) && parentDiv.contains(MP)) {
                                unuseTemplate('morePage');
                            } else {
                                insertTemplate(parentDiv, 'morePage');
                            }
                        };

                        parent.appendChild(parentDiv);
                    });
                });
        }
        findConvs();

        document.addEventListener('click', function(event) {
            if (event.target.closest('.moreBtn')) {
                return;
            }

            document.querySelectorAll('select').forEach(function(select) {
                if (!select.contains(event.target)) {
                    select.blur();
                }
            });

            const MP = document.getElementById('morePage');
            if (MP.parentElement.id !== "defs" && (!MP.contains(event.target))) {
                unuseTemplate('morePage');
            }
        });

        function insertTemplate(obj, id) {
            obj.appendChild(document.getElementById(id));
        }

        function copyTemplate(id) {
            const newElm = document.getElementById(id).cloneNode(true);
            newElm.removeAttribute('id');
            return newElm;
        }

        function unuseTemplate(id) {
            var obj = document.getElementById(id);
            const defs = document.getElementById('defs');
            defs.appendChild(obj);
        }

        function onChatGo() {} // For overriding
    </script>
</head>
<body onload="init()">
    <div id="defs">
        <svg>
            <defs>
                <symbol id="sideLeftIcon" viewBox="0 0 26 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="22" height="20" rx="5" ry="5"/>
                    <path d="M6 7 H7" stroke-width="2"/>
                    <path d="M6 10 H7" stroke-width="2"/>
                    <path d="M6 13 H7" stroke-width="2"/>
                    <path d="M11 22V2"/>
                </symbol>

                <symbol id="sideRightIcon" viewBox="0 0 26 24" fill="none" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="22" height="20" rx="5" ry="5"/>
                    <path d="M20 7 H19" stroke-width="2"/>
                    <path d="M20 10 H19" stroke-width="2"/>
                    <path d="M20 13 H19" stroke-width="2"/>
                    <path d="M15 22V2"/>
                </symbol>

                <symbol id="more" viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="20" cy="50" r="7" fill="black"/>
                    <circle cx="50" cy="50" r="7" fill="black"/>
                    <circle cx="80" cy="50" r="7" fill="black"/>
                </symbol>
            </defs>
        </svg>
        <svg id="spinner" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="42.83 20">
            <animate attributeName="stroke-dashoffset" from="0" to="62.83" dur="2s" repeatCount="indefinite" />
            <animate attributeName="stroke-dasharray" values="42.83 20;20 42.83;42.83 20" dur="2s" repeatCount="indefinite" />
          </circle>
        </svg>
        <div id="chatContainer">
            <div id="chatBorder">
                <span id="chatIn" data-placeholder="Message an AI" class="textarea placeholder noAccent" role="textbox" name="chatIn" onkeydown="if(event.key === 'Enter' && !event.shiftKey) {event.preventDefault();onChatGo()}" onselectstart="return !this.classList.contains('placeholder');" contenteditable></span>
            </div>
            <button onclick="onChatGo()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24">
                    <g fill="none" fill-rule="nonzero">
                        <path d="M24 0v24H0V0h24ZM12.593 23.258l-.011.002-.071.035-.02.004-.014-.004-.071-.035c-.01-.004-.019-.001-.024.005l-.004.01-.017.428.005.02.01.013.104.074.015.004.012-.004.104-.074.012-.016.004-.017-.017-.427c-.002-.01-.009-.017-.017-.018Zm.265-.113-.013.002-.185.093-.01.01-.003.011.018.43.005.012.008.007.201.093c.012.004.023 0 .029-.008l.004-.014-.034-.614c-.003-.012-.01-.02-.02-.022Zm-.715.002a.023.023 0 0 0-.027.006l-.006.014-.034.614c0 .012.007.02.017.024l.015-.002.201-.093.01-.008.004-.011.017-.43-.003-.012-.01-.01-.184-.092Z"/>
                        <path fill="#09244B" d="M20.25 3.532a1 1 0 0 1 1.183 1.329l-6 15.5a1 1 0 0 1-1.624.362l-3.382-3.235-1.203 1.202c-.636.636-1.724.186-1.724-.714v-3.288L2.309 9.723a1 1 0 0 1 .442-1.691l17.5-4.5Zm-2.114 4.305-7.998 6.607 3.97 3.798 4.028-10.405Zm-1.578-1.29L4.991 9.52l3.692 3.53 7.875-6.505Z"/>
                    </g>
                </svg>
            </button>
        </div>
        <div id="PrevChatBtn">
            <button class="prevChatBtn">
                <span></span>
                <div class="moreBtn" role="button" tabindex="0">
                    <svg class="moreBtnSvg" height="38" width="30">
                        <use href="#more"/>
                    </svg>
                </div>
            </button>
        </div>
        <div id="morePage">
            <p>HELLOOOO!</p>
        </div>
    </div>

    <div class="container">
        <div id="sideLeft" class="sidebar">
            <div class="sidebarColour">
                <button id="closeSideLeft" class="noAccent">
                    <svg width="36" height="36">
                        <use href="#sideLeftIcon"/>
                    </svg>
                </button>
                <button id="newChat" class="slightlyHidden" onclick="home()">
                    <svg fill="none" width="36" height="36" viewBox="0 0 48 48" stroke="currentColor" stroke-width="3.5" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="24" cy="24" r="20"/>
                        <path d="M24 14V34"/>
                        <path d="M14 24H34"/>
                    </svg>
                </button>
                <div id="prevChats" class="sidebarSegment"></div>
            </div>
        </div>
        <div id="topBar">
            <button id="openSideLeft" class="noAccent hidden">
                <svg width="36" height="36">
                    <use href="#sideLeftIcon"/>
                </svg>  
            </button>
        
            <button id="openSideRight" class="noAccent hidden">
                <svg width="36" height="36">
                    <use href="#sideRightIcon"/>
                </svg>  
            </button>
        </div>
        <div id="main"><!-- INSERT CODE --></div>
        <div id="sideRight" class="sidebar">
            <div class="sidebarColour">
                <div id="rightCloseButtonContainer">
                    <button id="closeSideRight" class="noAccent">
                        <svg width="36" height="36">
                            <use href="#sideRightIcon"/>
                        </svg>
                    </button>
                </div>
                <div id="RightSettings">
                    <h2>Chatbot</h2>
                    <p>AI Service:</p>
                    <div id="AIDropdowns"></div>
                    <p id="AIText"></p>
                    <hr>
                    <h2>Prompt settings</h2>
                </div>
            </div>
        </div>
    </div>
</body>